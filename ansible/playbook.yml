---
- name: Deploy MinIO Cluster with Keepalived VIP
  hosts: minio_nodes
  become: yes
  vars:
    minio_data_dir: /srv/minio
    keepalived_config_dir: /root/keepalived
    
  tasks:
    - name: Gather facts
      setup:

    # ==========================================
    # Pre-flight checks
    # ==========================================
    - name: Verify Docker is installed
      command: docker --version
      register: docker_check
      changed_when: false
      failed_when: false

    - name: Verify Docker Compose is installed
      command: docker compose version
      register: docker_compose_check
      changed_when: false
      failed_when: false

    - name: Fail if Docker is not installed
      fail:
        msg: "Docker is not installed. Please install Docker manually."
      when: docker_check.rc != 0

    - name: Fail if Docker Compose is not installed
      fail:
        msg: "Docker Compose is not installed. Please install Docker Compose manually."
      when: docker_compose_check.rc != 0

    - name: Check if MinIO image exists locally
      shell: docker images -q "{{ minio_image }}" | head -1
      register: minio_image_exists
      changed_when: false
      failed_when: false

    - name: Check if keepalived image exists locally
      shell: docker images -q "{{ keepalived_image }}" | head -1
      register: keepalived_image_exists
      changed_when: false
      failed_when: false

    - name: Verify MinIO image exists
      fail:
        msg: "MinIO image {{ minio_image }} is not found. Please ensure the image is loaded on this VM."
      when: minio_image_exists.stdout == ""

    - name: Verify keepalived image exists
      fail:
        msg: "Keepalived image {{ keepalived_image }} is not found. Please load it: docker pull {{ keepalived_image }}"
      when: keepalived_image_exists.stdout == ""

    # ==========================================
    # Detect and set variables
    # ==========================================
    - name: Detect network interface
      shell: |
        ip route | grep default | awk '{print $5}' | head -1 || echo "eth0"
      register: interface_result
      changed_when: false
      failed_when: false

    - name: Set network interface
      set_fact:
        detected_interface: "{{ interface_result.stdout | trim | default('eth0') }}"

    - name: Set keepalived interface
      set_fact:
        keepalived_interface_final: "{{ (keepalived_interface | trim) if (keepalived_interface is defined and keepalived_interface | trim != '') else detected_interface }}"

    - name: Finalize keepalived interface
      set_fact:
        keepalived_interface_final: "eth0"
      when: keepalived_interface_final is not defined or keepalived_interface_final | trim == ""

    - name: Debug interface detection
      debug:
        msg: "Detected interface: {{ detected_interface }}, Final interface: {{ keepalived_interface_final }}"

    - name: Set my_ip variable based on node
      set_fact:
        my_ip: "{{ vm1_ip if node_id == 1 else (vm2_ip if node_id == 2 else vm3_ip) }}"

    - name: Debug my_ip
      debug:
        msg: "Node {{ node_id }} IP: {{ my_ip }}"

    # ==========================================
    # Create directories
    # ==========================================
    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Create MinIO data directories
      file:
        path: "{{ minio_data_dir }}/data{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - 1
        - 2

    - name: Create MinIO deployment directory
      file:
        path: /root/minio
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create keepalived config directory
      file:
        path: "{{ keepalived_config_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    # ==========================================
    # Deploy configuration files
    # ==========================================
    - name: Deploy MinIO health check script
      template:
        src: check_minio.sh.j2
        dest: "{{ keepalived_config_dir }}/check_minio.sh"
        owner: root
        group: root
        mode: '0755'

    - name: Verify interface is set
      fail:
        msg: "Network interface is not set. Detected: {{ detected_interface | default('NOT SET') }}, Final: {{ keepalived_interface_final | default('NOT SET') }}"
      when: keepalived_interface_final is not defined or keepalived_interface_final | trim == ""

    - name: Deploy keepalived configuration
      template:
        src: keepalived.conf.j2
        dest: "{{ keepalived_config_dir }}/keepalived.conf"
        owner: root
        group: root
        mode: '0644'
      vars:
        my_ip: "{{ my_ip }}"
        vm1_ip: "{{ vm1_ip }}"
        vm2_ip: "{{ vm2_ip }}"
        vm3_ip: "{{ vm3_ip }}"

    - name: Deploy MinIO .env file
      template:
        src: minio.env.j2
        dest: "/root/minio/.env"
        owner: root
        group: root
        mode: '0600'
      vars:
        my_ip: "{{ my_ip }}"

    - name: Deploy MinIO docker-compose.yml
      template:
        src: docker-compose.yml.j2
        dest: "/root/minio/docker-compose.yml"
        owner: root
        group: root
        mode: '0644'
      vars:
        my_ip: "{{ my_ip }}"
        vm1_ip: "{{ vm1_ip }}"
        vm2_ip: "{{ vm2_ip }}"
        vm3_ip: "{{ vm3_ip }}"

    # ==========================================
    # Start services in correct order
    # ==========================================
    - name: Stop existing containers
      shell: |
        cd /root/minio
        docker compose down || true
      ignore_errors: yes

    - name: Start MinIO container first
      community.docker.docker_compose_v2:
        project_src: /root/minio
        state: present
        services:
          - minio

    - name: Wait for MinIO to be ready
      wait_for:
        port: 9000
        host: 127.0.0.1
        delay: 10
        timeout: 120

    - name: Start keepalived container (after MinIO is ready)
      community.docker.docker_compose_v2:
        project_src: /root/minio
        state: present
        services:
          - keepalived

    - name: Verify MinIO container is running
      shell: docker ps --filter name=minio --format "{{ '{{' }}.Names{{ '}}' }}"
      register: minio_status
      changed_when: false

    - name: Verify keepalived container is running
      shell: docker ps --filter name=keepalived --format "{{ '{{' }}.Names{{ '}}' }}"
      register: keepalived_status
      changed_when: false

    - name: Display container status
      debug:
        msg:
          - "MinIO: {{ minio_status.stdout }}"
          - "Keepalived: {{ keepalived_status.stdout }}"
